<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portmonote - Port Memory</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            900: '#121212',
                            800: '#1e1e1e',
                            700: '#2d2d2d',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .card-enter-active, .card-leave-active { transition: all 0.5s ease; }
        .card-enter-from, .card-leave-to { opacity: 0; transform: translateY(20px); }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased">
    <div id="app" class="min-h-screen p-6">
        
        <!-- Header -->
        <header class="max-w-7xl mx-auto mb-8 flex justify-between items-center border-b border-gray-700 pb-4">
            <div>
                <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-teal-400">
                    Portmonote
                </h1>
                <p class="text-gray-500 text-sm mt-1">Service Presence & Memory</p>
            </div>
            
            <div class="flex items-center gap-4">
                <span v-if="loading" class="text-yellow-400 text-sm animate-pulse">Updating...</span>
                <span v-else class="text-green-500 text-sm">Live</span>
                <button @click="fetchData" class="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded border border-gray-600 text-sm transition">
                    Refresh
                </button>
            </div>
        </header>

        <!-- Main Grid -->
        <main class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            
            <div v-for="port in sortedPorts" :key="port.protocol + '-' + port.port" 
                 class="bg-gray-800 rounded-xl p-5 border shadow-lg hover:shadow-xl hover:bg-gray-750 transition-all duration-300 relative group cursor-pointer"
                 :class="statusBorder(port)"
                 @click="editNote(port)">
                 
                <!-- Delete Button (Top Left) -->
                <button @click="(e) => initiateDelete(port, e)"
                        class="absolute top-2 left-2 p-1.5 rounded-full z-20 transition-all duration-200 opacity-0 group-hover:opacity-100 text-gray-600 hover:text-red-400 hover:bg-red-900/30">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>

                <!-- Pin Button (Top Right) -->
                <button @click="(e) => togglePin(port, e)" 
                        class="absolute top-2 right-2 p-1.5 rounded-full z-20 transition-all duration-200 group-hover:opacity-100"
                        :class="port.is_pinned ? 'text-blue-400 bg-blue-500/10 hover:bg-blue-500/20 opacity-100' : 'text-gray-600 hover:text-gray-300 hover:bg-gray-700 opacity-0'">
                   <!-- Pin Icon -->
                   <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" :class="{'fill-current': port.is_pinned, 'stroke-current stroke-2 fill-none': !port.is_pinned}" viewBox="0 0 24 24">
                       <path d="M12.8 3.5l3.7 3.7-.9 2 4.4 4.4-4 .6-3 5.3-1.5-1.5 1-4.1-5-3.3 2.5-3.5 2.8-3.6z"/>
                   </svg>
                </button>
                
                <!-- Status Indicator & Title -->
                <div class="flex justify-between items-start mb-3">
                    <div class="bg-gray-900 rounded px-2 py-1 text-xs font-mono text-gray-400 border border-gray-700">
                        {{ port.port }} / {{ port.protocol.toUpperCase() }}
                    </div>
                    <div class="flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-bold" 
                         :class="statusBadge(port)">
                        <span class="w-2 h-2 rounded-full" :class="statusDot(port)"></span>
                        {{ port.derived_status.toUpperCase() }}
                    </div>
                </div>

                <!-- Process Info -->
                <div class="mb-4">
                    <h2 class="text-lg font-bold text-white truncate" :title="port.process_name || 'Unknown Process'">
                        {{ port.process_name || 'Unknown' }}
                    </h2>
                    <p class="text-xs text-gray-500 font-mono truncate" :title="port.cmdline">
                        {{ port.cmdline || '-' }}
                    </p>
                </div>

                <!-- Memory / Note Section -->
                <div class="mb-4" v-if="port.title || port.description || port.owner">
                    <h3 class="text-blue-300 font-medium text-sm mb-1">{{ port.title || 'Untitled Service' }}</h3>
                    <p class="text-gray-400 text-xs leading-relaxed line-clamp-2" :title="port.description">
                        {{ port.description || 'No description provided.' }}
                    </p>
                </div>
                <div v-else class="mb-4 py-2 border-2 border-dashed border-gray-700 rounded text-center hover:border-gray-500 transition">
                    <span class="text-xs text-gray-600">+ Add Memory</span>
                </div>

                <!-- Meta Info -->
                <div class="flex justify-between items-end border-t border-gray-700 pt-3 mt-auto">
                    <div class="flex flex-col">
                        <span class="text-[10px] text-gray-500 uppercase tracking-wider">Owner</span>
                        <span class="text-xs text-gray-300">{{ port.owner || 'Unknown' }}</span>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="text-[10px] text-gray-500 uppercase tracking-wider">Uptime</span>
                        <span class="text-xs text-gray-300">{{ port.uptime_human || '-' }}</span>
                    </div>
                </div>
                
                <div v-if="port.first_seen_at" class="mt-2 text-[10px] text-gray-600 text-right">
                    First seen: {{ formatDate(port.first_seen_at) }}
                </div>
            </div>
        </main>

        <!-- Edit Modal -->
        <div v-if="editingPort" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 backdrop-blur-sm" @click.self="closeModal">
            <div class="bg-gray-800 rounded-lg max-w-4xl w-full shadow-2xl border border-gray-700 flex flex-col md:flex-row overflow-hidden max-h-[90vh]">
                
                <!-- Left: Edit Form -->
                <div class="p-6 w-full md:w-1/2 overflow-y-auto border-b md:border-b-0 md:border-r border-gray-700">
                    <h3 class="text-xl font-bold mb-4 flex justify-between items-center gap-2">
                         <span><span class="text-blue-400">#</span> Memory</span>
                         <span class="text-xs text-green-400 font-mono transition-opacity duration-500" :class="saving ? 'opacity-100' : 'opacity-0'">
                            Saved
                         </span>
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Title</label>
                            <input v-model="editForm.title" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm text-white focus:border-blue-500 outline-none placeholder-gray-600" placeholder="e.g. My Database">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Description</label>
                            <textarea v-model="editForm.description" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm text-white focus:border-blue-500 outline-none h-24 placeholder-gray-600" placeholder="What is this service for?"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Owner</label>
                                <input v-model="editForm.owner" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm text-white focus:border-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Risk Level</label>
                                <select v-model="editForm.risk_level" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm text-white focus:border-blue-500 outline-none">
                                    <option value="expected">Expected</option>
                                    <option value="trusted">Trusted (Green)</option>
                                    <option value="suspicious">Suspicious (Red)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="mt-8 flex justify-end gap-3 text-xs text-gray-500">
                             Changes are saved automatically. Click outside to close.
                        </div>
                    </div>
                </div>

                <!-- Right: Witr Diagnostics -->
                <div class="p-6 w-full md:w-1/2 bg-gray-900 flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-200">Diagnostics</h3>
                        <button @click="runWitr(editingPort.port)" 
                                class="px-3 py-1 text-xs bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded text-green-400 font-mono transition flex items-center gap-1"
                                :disabled="witrLoading">
                            <span v-if="witrLoading" class="animate-spin">‚ü≥</span>
                            <span v-else>>_</span>
                            run witr
                        </button>
                    </div>

                    <!-- History View Overlay logic -->
                    <div class="flex-1 bg-black rounded border border-gray-800 p-4 font-mono text-xs overflow-auto relative group">
                        <!-- Navigation Arrows -->
                        <div v-if="historyList.length > 0" class="absolute top-1/2 -left-3 -translate-y-1/2 z-20" :class="{'hidden': historyIndex >= historyList.length - 1}">
                             <button @click="historyIndex++" class="bg-gray-700 hover:bg-gray-600 rounded-full p-2 text-white shadow-lg border border-gray-600">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                             </button>
                        </div>
                        <div v-if="historyList.length > 0 && historyIndex > 0" class="absolute top-1/2 -right-3 -translate-y-1/2 z-20">
                             <button @click="historyIndex--" class="bg-gray-700 hover:bg-gray-600 rounded-full p-2 text-white shadow-lg border border-gray-600">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                             </button>
                        </div>
                        
                        <!-- Header info if browsing history -->
                        <div v-if="historyIndex > 0" class="absolute top-2 left-2 right-2 bg-yellow-900/40 border border-yellow-700/50 rounded p-2 mb-2 text-center backdrop-blur-sm z-10">
                            <span class="text-yellow-400 font-bold">Historical Snapshot ({{ historyIndex }}/{{historyList.length-1}})</span>
                            <div class="text-xs text-gray-300">{{ formatDate(currentSnapshot.timestamp) }}</div>
                             <div class="mt-1 flex justify-center gap-2">
                                <span class="bg-black/50 px-2 py-0.5 rounded text-gray-400">{{ currentSnapshot.event_type }}</span>
                            </div>
                        </div>

                        <!-- Content Render -->
                        <div v-if="historyIndex === 0">
                            <!-- Realtime Witr View -->
                             <div v-if="!witrOutput && !witrLoading" class="absolute inset-0 flex items-center justify-center text-gray-700 pointer-events-none">
                                <div class="text-center">
                                    <p class="mb-1 text-4xl opacity-20">üîç</p>
                                    <p>Click 'run witr' to inspect</p>
                                </div>
                            </div>
                            <div v-if="witrLoading" class="text-green-500 animate-pulse">
                                root@server:~$ witr --port {{ editingPort.port }}<br>
                                Analyzing traffic and process info...
                            </div>
                            <pre v-if="witrOutput" class="whitespace-pre-wrap text-gray-300 leading-relaxed" v-html="formatWitrOutput(witrOutput)"></pre>
                        </div>
                        <div v-else class="mt-16 text-gray-300">
                             <!-- Historical View -->
                             <div class="space-y-3">
                                <div class="p-2 border border-gray-700 rounded bg-gray-900/50">
                                    <span class="block text-gray-500 text-[10px] uppercase">Process Name</span>
                                    <span class="text-green-400 font-bold">{{ currentSnapshot.process_name || 'N/A' }}</span>
                                </div>
                                <div class="p-2 border border-gray-700 rounded bg-gray-900/50">
                                    <span class="block text-gray-500 text-[10px] uppercase">PID</span>
                                    <span class="text-blue-300 font-mono">{{ currentSnapshot.pid || 'N/A' }}</span>
                                </div>
                                <div class="p-4 text-center opacity-50 text-xs italic">
                                    Detailed diagnostics (witr) are not stored for historical events.
                                </div>
                             </div>
                        </div>
                    </div>
                    
                    <p class="mt-3 text-[10px] text-gray-600 text-center">
                        Powered by <a href="https://github.com/pranshuparmar/witr" target="_blank" class="hover:text-gray-400 underline">witr</a>
                    </p>
                </div>

            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div v-if="deletingPort" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-[60] backdrop-blur-sm">
            <div class="bg-gray-900 border border-red-900/50 rounded-lg max-w-sm w-full p-6 text-center shadow-2xl relative">
                
                <div class="flex justify-center mb-4">
                    <div class="p-3 bg-red-900/20 rounded-full">
                        <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    </div>
                </div>

                <h3 class="text-xl font-bold text-white mb-2">Delete Memory?</h3>
                <p class="text-sm text-gray-400 mb-6">
                    This will permanently wipe all history and notes for port <span class="text-white font-mono">{{ deletingPort.port }}</span>.
                    <br><br>
                    <span class="text-xs text-red-400">If the port is still active, it will reappear immediately.</span>
                </p>

                <div class="mb-6">
                    <label class="block text-xs text-gray-500 mb-2 uppercase tracking-wide">Type <span class="text-white font-bold">{{ deletingPort.port }}</span> to confirm</label>
                    <input v-model="deleteInput" class="w-full bg-black border border-gray-700 rounded p-2 text-center text-white focus:border-red-500 outline-none font-mono tracking-widest" placeholder="..."/>
                </div>

                <div class="flex gap-3">
                    <button @click="deletingPort = null" class="flex-1 px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded text-sm transition">Cancel</button>
                    <button @click="confirmDelete" 
                       :disabled="deleteInput !== String(deletingPort.port) || isDeleting"
                       class="flex-1 px-4 py-2 rounded text-sm font-bold transition flex justify-center items-center"
                       :class="deleteInput === String(deletingPort.port) ? 'bg-red-600 hover:bg-red-700 text-white shadow-lg shadow-red-900/50' : 'bg-gray-800 text-gray-600 cursor-not-allowed'">
                       <span v-if="isDeleting" class="animate-spin mr-2">‚ü≥</span>
                       Delete
                    </button>
                </div>

            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const ports = ref([]);
                const loading = ref(false);
                const editingPort = ref(null);
                const editForm = ref({});
                const saving = ref(false);
                const isInit = ref(false);

                // Delete Logic
                const deletingPort = ref(null);
                const deleteInput = ref("");
                const isDeleting = ref(false);
                
                // Witr Logic
                const witrOutput = ref(null);
                const witrLoading = ref(false);

                // History Logic
                const historyList = ref([]);
                const historyIndex = ref(0); // 0 = latest/realtime

                const currentSnapshot = computed(() => {
                    if (historyIndex.value === 0 || historyList.value.length === 0) return null;
                    // historyList is sorted desc (0 is latest)
                    // But our index 0 is "Live View", index 1 is "Latest Event", index 2 is "Previous Event"
                    // So historyIndex 1 maps to historyList[0]
                    return historyList.value[historyIndex.value - 1]; 
                });

                const sortedPorts = computed(() => {
                    return [...ports.value].sort((a, b) => {
                        // Priority Logic:
                        // 1. Suspicious (Absolute Top)
                        // 2. Pinned
                        // 3. Trusted (Green)
                        // 4. Expected (Gray)
                        
                        const score = (p) => {
                            let s = 0;
                            const status = p.derived_status;
                            const risk = p.risk_level;

                            // 1. Critical Status (Overrides everything)
                            if (status === 'suspicious' || risk === 'suspicious') s += 10000;
                            
                            // 2. User Pin (High priority)
                            if (p.is_pinned) s += 5000;

                            // 3. Normal logic
                            // Trusted > Expected
                            if (risk === 'trusted') s += 1000;
                            else if (risk === 'expected') s += 100;

                            // 4. Tie-breaker: Port number (lower is better usually, or use uptime)
                            return s;
                        };
                        return score(b) - score(a);
                    });
                });

                const fetchHistory = async (port) => {
                    historyList.value = [];
                    historyIndex.value = 0; // Reset to latest
                    try {
                        const url = `/history?host_id=${port.host_id}&protocol=${port.protocol}&port=${port.port}`;
                        const res = await fetch(url);
                        if(res.ok) {
                            historyList.value = await res.json();
                        }
                    } catch(e) { console.error("History fetch failed", e); }
                };

                const fetchData = async () => {
                    loading.value = true;
                    try {
                        const res = await fetch('/ports');
                        if(res.ok) ports.value = await res.json();
                    } catch (e) {
                        console.error(e);
                    } finally {
                        loading.value = false;
                    }
                };

                const runWitr = async (port) => {
                    witrLoading.value = true;
                    witrOutput.value = null;
                    try {
                        const res = await fetch(`/inspect/${port}`);
                        const data = await res.json();
                        witrOutput.value = data.output;
                    } catch(e) {
                        witrOutput.value = "Failed to run witr diagnostics.";
                    } finally {
                        witrLoading.value = false;
                    }
                };
                
                // ANSI color parser
                const formatWitrOutput = (text) => {
                    if(!text) return '';
                    
                    // 1. Basic cleaning of HTML chars
                    let safe = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    
                    // 2. ANSI Codes -> HTML
                    const colors = {
                        30: 'text-gray-500', 31: 'text-red-400', 32: 'text-green-400', 33: 'text-yellow-400',
                        34: 'text-blue-400', 35: 'text-purple-400', 36: 'text-cyan-400', 37: 'text-gray-200'
                    };
                    
                    // Replace [2m (Dim)
                    safe = safe.replace(/\x1b\[2m/g, '<span class="opacity-60">');
                    
                    // Replace Colors
                    safe = safe.replace(/\x1b\[(3[0-7])m/g, (match, p1) => {
                        return `<span class="${colors[p1] || ''}">`;
                    });
                    
                    // Replace [0m (Reset) or others
                    safe = safe.replace(/\x1b\[0m/g, '</span>');
                    safe = safe.replace(/\x1b\[1m/g, '<b class="font-bold">');
                    
                    // Clean leftovers
                    safe = safe.replace(/\x1b\[[0-9;]*[a-zA-Z]/g, ''); 
                    
                    return safe;
                };


                const statusBorder = (original) => {
                    const status = original.derived_status;
                    const risk = original.risk_level;
                    const isDisappeared = original.current_state === 'disappeared';
                    const lastEvt = original.latest_event_type;

                    // Warning Flash for Process Change (Overrides everything except Disappeared maybe?)
                    if (lastEvt === 'process_change') {
                        return 'border-yellow-500 bg-yellow-900/20 animate-pulse ring-1 ring-yellow-500';
                    }
                    
                    // Base Colors
                    let base = '';
                    if (status === 'suspicious' || risk === 'suspicious') base = 'border-red-600 shadow-red-900/20';
                    else if (risk === 'trusted') base = 'border-green-800 hover:border-green-600';
                    else base = 'border-gray-700 hover:border-gray-500'; // Expected

                    // Blinking Logic for Disappeared
                    if (isDisappeared) {
                        if (status === 'suspicious' || risk === 'suspicious') return 'border-red-500 bg-red-900/10 animate-pulse'; // Bright Red Blink
                        if (risk === 'trusted') return 'border-red-500/60 bg-green-900/10 animate-pulse'; // Red Border + Greenish bg
                        return 'border-red-900/50 bg-gray-900/50 animate-pulse'; // Gray/Red Blink
                    }

                    return base;
                };

                const statusBadge = (original) => {
                    const status = original.derived_status;
                    const risk = original.risk_level;
                    const isDisappeared = original.current_state === 'disappeared';
                    const lastEvt = original.latest_event_type;

                    if (lastEvt === 'process_change') return 'bg-yellow-900/40 text-yellow-400 border border-yellow-700/50';

                    if (status === 'suspicious' || risk === 'suspicious') return 'bg-red-900/30 text-red-400';
                    if (risk === 'trusted') return isDisappeared ? 'bg-red-900/20 text-red-400' : 'bg-green-900/30 text-green-400';
                    
                    // Expected
                    return isDisappeared ? 'bg-red-900/10 text-gray-500' : 'bg-gray-800 text-gray-500';
                };

                const statusDot = (original) => {
                    const status = original.derived_status;
                    const risk = original.risk_level;
                    const isDisappeared = original.current_state === 'disappeared';
                    const lastEvt = original.latest_event_type;

                    if (lastEvt === 'process_change') return 'bg-yellow-500 animate-bounce';

                    if (isDisappeared) return 'bg-red-500 animate-ping'; // All disappeared ping red

                    if (status === 'suspicious' || risk === 'suspicious') return 'bg-red-500';
                    if (risk === 'trusted') return 'bg-green-400';
                    return 'bg-gray-500'; // Expected
                }

                const formatDate = (str) => {
                    if(!str) return '';
                    return new Date(str).toLocaleDateString();
                }

                const closeModal = () => {
                    editingPort.value = null;
                }

                const editNote = (port) => {
                    editingPort.value = port;
                    witrOutput.value = null; // Reset witr
                    fetchHistory(port); 
                    
                    // Prevent watch trigger during init
                    isInit.value = true; 
                    
                    // Determine initial risk level:
                    // If existing note -> use its risk
                    // If no note (unknown) AND port is suspicious -> default to suspicious
                    // Else -> default to expected
                    let initialRisk = 'expected';
                    if (port.risk_level && port.risk_level !== 'unknown') {
                        initialRisk = port.risk_level;
                    } else if (port.derived_status === 'suspicious') {
                        initialRisk = 'suspicious';
                    }

                    editForm.value = {
                        title: port.title || '',
                        description: port.description || '',
                        owner: port.owner || '',
                        risk_level: initialRisk,
                        is_pinned: port.is_pinned || false
                    };
                    
                    // Allow watch after a tick
                    setTimeout(() => { isInit.value = false; }, 100);
                };

                const togglePin = async (port, event) => {
                    event.stopPropagation();
                    const newPinnedState = !port.is_pinned;
                    
                    // Optimistic update
                    port.is_pinned = newPinnedState;

                    try {
                        const url = `/notes?host_id=${port.host_id}&protocol=${port.protocol}&port=${port.port}`;
                        const res = await fetch(url, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ is_pinned: newPinnedState })
                        });
                        if (!res.ok) {
                            // Revert on failure
                            port.is_pinned = !newPinnedState;
                            console.error("Failed to pin");
                        }
                    } catch(e) {
                         port.is_pinned = !newPinnedState;
                         console.error(e);
                    }
                };

                const initiateDelete = (port, event) => {
                    event.stopPropagation();
                    deletingPort.value = port;
                    deleteInput.value = "";
                };

                const confirmDelete = async () => {
                    if (!deletingPort.value) return;
                    if (deleteInput.value !== String(deletingPort.value.port)) return;
                    
                    isDeleting.value = true;
                    try {
                        const p = deletingPort.value;
                        const url = `/ports?host_id=${p.host_id}&protocol=${p.protocol}&port=${p.port}`;
                        const res = await fetch(url, { method: 'DELETE' });
                        if(res.ok) {
                            deletingPort.value = null; // Close modal
                            fetchData(); // Refresh list
                        }
                    } catch(e) {
                        console.error("Delete failed", e);
                    } finally {
                        isDeleting.value = false;
                    }
                };

                const saveNote = async () => {
                    if (!editingPort.value) return;
                    saving.value = true;
                    const p = editingPort.value;
                    try {
                        const url = `/notes?host_id=${p.host_id}&protocol=${p.protocol}&port=${p.port}`;
                        const res = await fetch(url, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(editForm.value)
                        });
                        if (res.ok) {
                            fetchData(); // Refresh bg list
                        }
                    } catch(e) {
                         console.error("Save failed");
                    } finally {
                        setTimeout(() => saving.value = false, 800);
                    }
                };
                
                // Auto-save debouncer
                let debounceTimer = null;
                watch(editForm, (newVal) => {
                    // Prevent watch trigger during initialization
                    if(isInit.value || !editingPort.value) return; 
                    
                    if(debounceTimer) clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        saveNote();
                    }, 1000); 
                }, { deep: true });

                onMounted(() => {
                    fetchData();
                    setInterval(fetchData, 30000); // Polling every 30s
                });

                return {
                    ports, sortedPorts, loading, fetchData,
                    statusBorder, statusBadge, statusDot, formatDate,
                    editNote, editingPort, editForm, saveNote, saving, closeModal, togglePin,
                    initiateDelete, confirmDelete, deletingPort, deleteInput, isDeleting,
                    runWitr, witrOutput, witrLoading, formatWitrOutput,
                    historyList, historyIndex, currentSnapshot
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
